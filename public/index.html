// User Management Routes (Admin only) app.patch('/api/users/:id',
authenticateToken, requireAdmin, async (req, res) => { try { const { isActive }
= req.body; const user = await User.findByIdAndUpdate( req.params.id, { isActive
}, { new: true } ); if (!user) return res.status(404).json({ error: 'User not
found' }); // Log activity await ActivityLog.create({ username:
req.user.username, action: isActive ? 'USER_ENABLED' : 'USER_DISABLED',
entityType: 'User', entityId: user.username }); res.json(user); } catch (err) {
res.status(500).json({ error: err.message }); } }); app.delete('/api/users/:id',
authenticateToken, requireAdmin, async (req, res) => { try { const user = await
User.findById(req.params.id); if (!user) return res.status(404).json({ error:
'User not found' }); // Prevent self-deletion if (user._id.toString() ===
req.user._id.toString()) { return res.status(400).json({ error: 'Cannot delete
yourself' }); } await User.findByIdAndDelete(req.params.id); await
ActivityLog.create({ username: req.user.username, action: 'USER_DELETED',
entityType: 'User', entityId: user.username }); res.json({ message: 'User
deleted' }); } catch (err) { res.status(500).json({ error: err.message }); } });
// Truck/Vehicle Delete app.delete('/api/trucks/:id', authenticateToken,
requireAdmin, async (req, res) => { try { await
Truck.findByIdAndDelete(req.params.id); await Repair.deleteMany({ truckId:
req.params.id }); // Optional: delete associated repairs await
ActivityLog.create({ username: req.user.username, action: 'TRUCK_DELETED',
entityType: 'Truck', entityId: req.params.id }); res.json({ message: 'Vehicle
deleted' }); } catch (err) { res.status(500).json({ error: err.message }); } });
// Repairs List Route app.get('/api/repairs', authenticateToken, async (req,
res) => { try { const repairs = await Repair.find() .sort({ date: -1 })
.limit(50) .populate('truckId', 'name truckId'); const formatted = repairs.map(r
=> ({ ...r.toObject(), truckName: r.truckId?.name, truckId: r.truckId?.truckId
|| r.truckId })); res.json(formatted); } catch (err) { res.status(500).json({
error: err.message }); } }); // Middleware helpers function requireAdmin(req,
res, next) { if (req.user.role !== 'admin') { return res.status(403).json({
error: 'Admin access required' }); } next(); }
